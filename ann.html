<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸æ ¡å…¬å‘Šçµ„ä»¶</title>
    <style>
        :root {
            --bg-color: transparent; 
            --text-color: #222222;
            --link-color: #0044cc;
            --focus-outline: 0.25rem solid #ffcc00;
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --btn-active-bg: #0044cc;
            --btn-active-text: #ffffff;
            
            /* æ¨™ç±¤é¡è‰² */
            --tag-bg-1: #0066cc; /* è—è‰² */
            --tag-bg-2: #2e7d32; /* ç¶ è‰² */
            --tag-bg-dept: #f0f0f0; /* è™•å®¤é è¨­ç° */
        }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
            margin: 0;
            padding: 0;
            font-size: 1rem;
        }

        .container {
            width: 100%; max-width: 100%; margin: 0; padding: 0 5px; box-sizing: border-box;
        }

        /* --- SVG åœ–ç¤º --- */
        .icon-svg { display: inline-block; vertical-align: text-bottom; }
        .icon-top { color: #d32f2f; margin-right: 4px; width: 18px; height: 18px; }
        .icon-new { margin-left: 6px; height: 18px; vertical-align: middle; }

        /* --- åˆ†é¡ç¯©é¸ --- */
        .filter-section {
            display: flex; flex-wrap: wrap; gap: 0.4rem;
            margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #ddd;
        }
        .filter-btn {
            background-color: #fff; border: 1px solid #0044cc; color: #0044cc;
            padding: 0.2rem 0.6rem; font-size: 0.9rem; border-radius: 2rem;
            cursor: pointer; transition: all 0.2s;
        }
        .filter-btn:hover { background-color: #e6f0ff; }
        .filter-btn.active { background-color: var(--btn-active-bg); color: var(--btn-active-text); }
        .filter-btn:focus { outline: var(--focus-outline); }
        .count-badge {
            background-color: #eee; color: #333; font-size: 0.8em;
            padding: 1px 5px; border-radius: 10px; margin-left: 4px;
        }
        .filter-btn.active .count-badge { background-color: rgba(255,255,255,0.3); color: #fff; }

        /* --- åˆ—è¡¨æ¨£å¼ --- */
        .announcement-list { list-style: none; padding: 0; margin: 0; }
        .list-item {
            border-bottom: 1px solid #eee; padding: 0.6rem 0.4rem;
            display: flex; align-items: center; gap: 0.8rem;
        }
        .list-item:hover { background-color: rgba(0,0,0,0.03); }
        
        .list-date { font-family: monospace; font-size: 0.95rem; color: #555; flex-shrink: 0; width: 11ch; }
        
        /* â˜… æ¨™ç±¤å®¹å™¨èª¿æ•´ï¼šæ”¯æ´å¤šæ¨™ç±¤ï¼Œç§»é™¤å›ºå®šå¯¬åº¦ â˜… */
        .list-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            min-width: 80px; /* çµ¦å€‹æœ€å°å¯¬åº¦ï¼Œé¿å…å¤ªæ“  */
            max-width: 25%; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé¿å…æ¨™ç±¤å¤ªå¤šæ“ å£“åˆ°æ¨™é¡Œ */
        }

        /* å€‹åˆ¥æ¨™ç±¤æ¨£å¼ */
        .tag-badge {
            padding: 0.2rem 0.5rem; 
            border-radius: 4px;
            font-size: 0.85rem; 
            white-space: nowrap;
            display: inline-block;
        }
        
        .tag-cat-primary { background-color: var(--tag-bg-1); color: #fff; }
        .tag-cat-secondary { background-color: var(--tag-bg-2); color: #fff; }
        .tag-dept { background-color: var(--tag-bg-dept); color: #333; }

        .list-title { flex-grow: 1; }
        .title-btn {
            background: none; border: none; padding: 0; font-size: 1.05rem;
            color: var(--link-color); text-decoration: none; cursor: pointer;
            text-align: left; font-weight: bold; font-family: inherit;
            line-height: 1.5; display: inline-block;
        }
        .title-btn:hover { color: #002266; text-decoration: underline; }
        .title-btn:focus { outline: var(--focus-outline); background-color: #000; color: #ffcc00; }

        /* --- åˆ†é èˆ‡Modal --- */
        .pagination {
            display: flex; justify-content: center; align-items: center;
            gap: 1rem; margin-top: 1rem; margin-bottom: 1rem;
        }
        .page-btn {
            padding: 0.3rem 0.8rem; font-size: 0.9rem; cursor: pointer;
            background-color: #fff; border: 1px solid #999; border-radius: 4px;
        }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-overlay); display: none;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .modal-content {
            background: #fff; width: 90%; max-width: 70ch; max-height: 90vh;
            overflow-y: auto; padding: 1.5rem; border: 2px solid #000;
            border-radius: 0.5rem; position: relative;
        }
        .modal-body { white-space: pre-wrap; line-height: 1.8; }
        .modal-body * { color: #000 !important; background: transparent !important; font-size: inherit !important; font-family: inherit !important; }
        .close-btn {
            position: absolute; top: 1rem; right: 1rem;
            background: #cc0000; color: #fff; border: 1px solid #000;
            padding: 0.3rem 1rem; font-weight: bold; cursor: pointer;
        }
        .attachments-area { background: #f4f4f4; padding: 1rem; border: 1px dashed #666; margin-top: 1rem; }
        .attachments-area a { color: var(--link-color); font-weight: bold; display: inline-block; padding: 0.3rem; }
        #loading { font-size: 0.9rem; color: #666; padding: 1rem; text-align: center; }

        @media (max-width: 600px) {
            .list-item { flex-direction: column; align-items: flex-start; gap: 0.3rem; }
            .list-date { width: auto; font-size: 0.85rem; display: inline-block; margin-right: 10px;}
            .list-tags { max-width: 100%; margin-bottom: 4px; } /* æ‰‹æ©Ÿç‰ˆè®“æ¨™ç±¤ç¨ä½”ä¸€è¡Œ */
            .modal-content { width: 95%; padding: 1rem; }
            .filter-section { gap: 0.3rem; }
            .filter-btn { font-size: 0.85rem; padding: 0.2rem 0.5rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="loading">â†» è³‡æ–™è¼‰å…¥ä¸­...</div>
    <nav class="filter-section" aria-label="å…¬å‘Šåˆ†é¡ç¯©é¸">
        <button class="filter-btn active" data-cat="all">å…¨éƒ¨å…¬å‘Š</button>
    </nav>
    <ul id="announcement-list" class="announcement-list" aria-live="polite"></ul>
    <div class="pagination" id="pagination-controls" style="display:none;">
        <button id="prev-btn" class="page-btn">â† ä¸Šä¸€é </button>
        <span id="page-info" style="font-weight:bold; font-size: 0.9rem;">1 / 1</span>
        <button id="next-btn" class="page-btn">ä¸‹ä¸€é  â†’</button>
    </div>
</div>

<div id="detail-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
        <button id="modal-close-btn" class="close-btn" aria-label="é—œé–‰è¦–çª—">é—œé–‰ X</button>
        <div style="border-bottom: 2px solid #eee; margin-bottom: 1rem; padding-bottom: 0.5rem;">
            <h2 id="modal-title" style="margin:0 0 10px 0;">å…¬å‘Šè©³ç´°å…§å®¹</h2>
            <div style="color:#555;">
                <span id="modal-date"></span> | <span id="modal-dept"></span>
            </div>
        </div>
        <div id="modal-body" class="modal-body"></div>
        <div id="modal-attachments" class="attachments-area" style="display:none;">
            <h3>ğŸ“ é™„ä»¶ä¸‹è¼‰ï¼š</h3>
            <ul id="attachment-list" style="padding-left:1.5rem;"></ul>
        </div>
    </div>
</div>

<script>
    // â˜… è«‹ç¢ºèªæ­¤è™•ç‚ºæ‚¨çš„ GAS ç¶²å€ â˜…
    const DATA_URL = "https://script.google.com/macros/s/AKfycbxeoMbP6WVHLsG_hRULG_iuXlXiIIx0abYG0v0wh7ahqnKXn4qsqJe7sbz2Rnom5RKZ/exec";
    const ITEMS_PER_PAGE = 15;
    const NEW_DAYS_LIMIT = 7; 

    // SVG åœ–ç¤º
    const SVG_TOP = `<svg class="icon-svg icon-top" viewBox="0 0 24 24" fill="currentColor"><path d="M16 9V4l1 0c0.55 0 1-0.45 1-1s-0.45-1-1-1H7C6.45 2 6 2.45 6 3s0.45 1 1 1l1 0v5c0 1.66-1.34 3-3 3v2h5.97v7l1 1 1-1v-7H19v-2c-1.66 0-3-1.34-3-3z"></path></svg>`;
    const SVG_NEW = `<svg class="icon-svg icon-new" viewBox="0 0 34 16"><rect width="34" height="16" rx="3" fill="#d32f2f"/><text x="17" y="12" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-weight="bold" font-size="10">NEW</text></svg>`;

    const CATEGORY_MAP = {
        "2": "è¡Œæ”¿å…¬å‘Š", "35": "è£œåŠ©åŠçåŠ©å­¸é‡‘", "36": "äººäº‹å®¤å…¬å‘Š", "30": "æœƒè¨ˆå®¤å…¬å‘Š",
        "31": "å®¶é•·å°ˆå€", "38": "æ€§åˆ¥å¹³ç­‰", "28": "äººæ¬ŠäºŒå…¬ç´„", "37": "æ ¡å…§å…¬å‘Š",
        "48": "äººå“¡ç”„é¸", "39": "å¹¼å…’åœ’", "29": "é«”è‚²è³½äº‹ã€æ´»å‹•", "156": "æ–°ç”Ÿå ±åˆ°å°ˆå€",
        "168": "å®‰å…¨æ£’çƒ", "7": "ç ”ç¿’å…¬å‘Š"
    };

    let allData = [];
    let filteredData = []; 
    let currentPage = 1;
    let currentCategory = 'all';
    let lastFocusedElement = null;

    const listContainer = document.getElementById('announcement-list');
    const loadingDiv = document.getElementById('loading');
    const paginationControls = document.getElementById('pagination-controls');
    const pageInfo = document.getElementById('page-info');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const filterSection = document.querySelector('.filter-section');
    const modal = document.getElementById('detail-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalDate = document.getElementById('modal-date');
    const modalDept = document.getElementById('modal-dept');
    const modalBody = document.getElementById('modal-body');
    const modalAttachments = document.getElementById('modal-attachments');
    const attachmentList = document.getElementById('attachment-list');
    const closeBtn = document.getElementById('modal-close-btn');

    function checkIsNew(dateStr) {
        if (!dateStr) return false;
        const parts = dateStr.split(' ')[0].split('.'); 
        if (parts.length !== 3) return false;
        const year = parseInt(parts[0]) + 1911;
        const month = parseInt(parts[1]) - 1; 
        const day = parseInt(parts[2]);
        const postDate = new Date(year, month, day);
        const today = new Date();
        const diffTime = Math.abs(today - postDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        return diffDays <= NEW_DAYS_LIMIT;
    }

    fetch(DATA_URL)
        .then(res => res.json())
        .then(json => {
            if (json.status !== "success") throw new Error("GAS Error");
            loadingDiv.style.display = 'none';
            if (!json.data || json.data.length === 0) {
                listContainer.innerHTML = "<li style='padding:10px; color:#666;'>ç›®å‰æ²’æœ‰å…¬å‘Šã€‚</li>";
                return;
            }
            allData = json.data;
            filteredData = allData; 
            initFilters();
            initPagination();
            renderPage(1);
        })
        .catch(err => {
            console.error(err);
            loadingDiv.innerHTML = `<span style="color:red; font-size:0.9rem;">è³‡æ–™è¼‰å…¥å¤±æ•— (è«‹ç¢ºèª GAS æ˜¯å¦å·²éƒ¨ç½²æ–°ç‰ˆæœ¬)</span>`;
        });

    function initFilters() {
        const counts = {};
        allData.forEach(item => {
            // è¨ˆç®—åˆ†é¡æ•¸é‡ (å¦‚æœä¸€å€‹å…¬å‘Šæœ‰å¤šå€‹åˆ†é¡ï¼Œæ¯å€‹éƒ½è¦åŠ  1)
            if (item.category_ids && Array.isArray(item.category_ids)) {
                item.category_ids.forEach(catId => {
                     counts[catId] = (counts[catId] || 0) + 1;
                });
            }
        });
        Object.keys(CATEGORY_MAP).forEach(catId => {
            const name = CATEGORY_MAP[catId];
            const count = counts[catId] || 0;
            const btn = document.createElement('button');
            btn.className = 'filter-btn';
            btn.dataset.cat = catId;
            btn.innerHTML = `${name} <span class="count-badge">${count}</span>`;
            btn.addEventListener('click', () => {
                applyFilter(catId);
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
            filterSection.appendChild(btn);
        });
        const allBtn = document.querySelector('[data-cat="all"]');
        allBtn.innerHTML = `å…¨éƒ¨å…¬å‘Š <span class="count-badge">${allData.length}</span>`;
        allBtn.addEventListener('click', () => {
            applyFilter('all');
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            allBtn.classList.add('active');
        });
    }

    function applyFilter(category) {
        currentCategory = category;
        if (category === 'all') {
            filteredData = allData;
        } else {
            // ç¯©é¸é‚è¼¯æ›´æ–°ï¼šæª¢æŸ¥ category_ids é™£åˆ—ä¸­æ˜¯å¦åŒ…å«è©²åˆ†é¡
            filteredData = allData.filter(item => {
                return item.category_ids && item.category_ids.includes(category);
            });
        }
        currentPage = 1;
        renderPage(1);
        updatePaginationVisibility();
    }

    function updatePaginationVisibility() {
        paginationControls.style.display = (filteredData.length > ITEMS_PER_PAGE) ? 'flex' : 'none';
    }

    function initPagination() {
        updatePaginationVisibility();
        prevBtn.addEventListener('click', () => { if (currentPage > 1) renderPage(currentPage - 1); });
        nextBtn.addEventListener('click', () => { 
            const maxPage = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
            if (currentPage < maxPage) renderPage(currentPage + 1); 
        });
    }

    function renderPage(page) {
        currentPage = page;
        listContainer.innerHTML = "";
        if (filteredData.length === 0) {
            listContainer.innerHTML = "<li style='padding:20px; text-align:center; color:#666;'>æ­¤åˆ†é¡æ²’æœ‰å…¬å‘Šã€‚</li>";
            pageInfo.textContent = "0 / 0";
            return;
        }
        const start = (page - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const pageItems = filteredData.slice(start, end);
        const maxPage = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
        
        pageInfo.textContent = `${currentPage} / ${maxPage}`;
        prevBtn.disabled = (currentPage === 1);
        nextBtn.disabled = (currentPage === maxPage);

        pageItems.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'list-item';
            const simpleDate = item.date ? item.date.split(' ')[0] : '-';
            
            // â˜… ç”Ÿæˆå¤šé‡æ¨™ç±¤ HTML â˜…
            let tagsHtml = '';
            if (item.category_ids && Array.isArray(item.category_ids) && item.category_ids.length > 0) {
                item.category_ids.forEach((id, i) => {
                    const catName = CATEGORY_MAP[id];
                    if (catName) {
                        // ç‚ºäº†è¦–è¦ºå¥½çœ‹ï¼Œäº¤æ›¿ä½¿ç”¨ä¸åŒé¡è‰²
                        const colorClass = (i % 2 === 0) ? 'tag-cat-primary' : 'tag-cat-secondary';
                        tagsHtml += `<span class="tag-badge ${colorClass}">${catName}</span>`;
                    }
                });
            }
            // å¦‚æœæ²’åˆ†é¡ï¼Œé¡¯ç¤ºè™•å®¤
            if (!tagsHtml) {
                tagsHtml = `<span class="tag-badge tag-dept">${item.department}</span>`;
            }

            // åœ–ç¤ºé‚è¼¯
            let topHtml = "";
            if (item.is_top == 1 || item.is_top === "1") {
                topHtml = SVG_TOP;
            }
            let newHtml = "";
            if (checkIsNew(item.date)) {
                newHtml = SVG_NEW;
            }

            li.innerHTML = `
                <div class="list-date" aria-label="æ—¥æœŸ">${simpleDate}</div>
                <div class="list-tags" aria-label="åˆ†é¡">
                    ${tagsHtml}
                </div>
                <div class="list-title">
                    <button class="title-btn" onclick="openDetails(${start + index})" aria-label="æŸ¥çœ‹ï¼š${item.title}">
                        ${topHtml}${item.title}${newHtml}
                    </button>
                </div>
            `;
            listContainer.appendChild(li);
        });
    }

    window.openDetails = function(index) {
        const item = filteredData[index];
        lastFocusedElement = document.activeElement;
        modalTitle.textContent = item.title;
        modalDate.textContent = "ç™¼å¸ƒæ—¥æœŸï¼š" + item.date;
        modalDept.textContent = "ç™¼å¸ƒå–®ä½ï¼š" + item.department;
        modalBody.innerHTML = item.content_html;
        if (item.attachments && item.attachments.length > 0) {
            modalAttachments.style.display = 'block';
            attachmentList.innerHTML = item.attachments.map(f => `
                <li><a href="${f.url}" target="_blank">ä¸‹è¼‰ï¼š${f.name}</a></li>
            `).join('');
        } else {
            modalAttachments.style.display = 'none';
        }
        modal.style.display = 'flex';
        closeBtn.focus();
        document.body.style.overflow = 'hidden';
    };

    function closeModal() {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        if (lastFocusedElement) lastFocusedElement.focus();
    }

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.style.display === 'flex') closeModal(); });

</script>

</body>
</html>