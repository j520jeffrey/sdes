<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸æ ¡å…¬å‘Šçµ„ä»¶</title>
    <style>
        :root {
            /* é è¨­èƒŒæ™¯é€æ˜ï¼Œèå…¥åµŒå…¥ç¶²é  */
            --bg-color: transparent; 
            --text-color: #222222;
            --link-color: #0044cc;
            --focus-outline: 0.25rem solid #ffcc00;
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --btn-active-bg: #0044cc;
            --btn-active-text: #ffffff;
        }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
            margin: 0;
            padding: 0;
            font-size: 1rem;
        }

        .container {
            width: 100%;
            max-width: 100%; 
            margin: 0;
            padding: 0 5px;
            box-sizing: border-box;
        }

        /* --- åœ–ç¤ºæ¨£å¼ (Base64) --- */
        .icon-top {
            width: 18px; 
            height: 18px;
            vertical-align: text-bottom;
            margin-right: 4px;
        }

        .icon-new {
            width: 32px;
            height: 16px;
            vertical-align: middle;
            margin-left: 6px;
        }

        /* --- åˆ†é¡ç¯©é¸ --- */
        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-bottom: 0.8rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid #ddd;
        }

        .filter-btn {
            background-color: #fff;
            border: 1px solid #0044cc;
            color: #0044cc;
            padding: 0.2rem 0.6rem;
            font-size: 0.9rem;
            border-radius: 2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover { background-color: #e6f0ff; }
        .filter-btn.active { background-color: var(--btn-active-bg); color: var(--btn-active-text); }
        .filter-btn:focus { outline: var(--focus-outline); }
        
        .count-badge {
            background-color: #eee; color: #333; font-size: 0.8em;
            padding: 1px 5px; border-radius: 10px; margin-left: 4px;
        }
        .filter-btn.active .count-badge { background-color: rgba(255,255,255,0.3); color: #fff; }

        /* --- åˆ—è¡¨æ¨£å¼ --- */
        .announcement-list { list-style: none; padding: 0; margin: 0; }

        .list-item {
            border-bottom: 1px solid #eee;
            padding: 0.6rem 0.4rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .list-item:hover { background-color: rgba(0,0,0,0.03); }

        .list-date {
            font-family: monospace; font-size: 0.95rem; color: #555;
            flex-shrink: 0; width: 11ch; 
        }

        .list-dept {
            background-color: #eee; padding: 0.2rem 0.4rem; border-radius: 0.2rem;
            font-size: 0.85rem; color: #333; flex-shrink: 0; width: 7.5em; 
            text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        .list-title { flex-grow: 1; }

        .title-btn {
            background: none; border: none; padding: 0; font-size: 1.05rem;
            color: var(--link-color); text-decoration: none; cursor: pointer;
            text-align: left; font-weight: bold; font-family: inherit;
            line-height: 1.5;
            display: inline-block; /* ç¢ºä¿åœ–ç¤ºå°é½Š */
        }

        .title-btn:hover { color: #002266; text-decoration: underline; }
        .title-btn:focus { outline: var(--focus-outline); background-color: #000; color: #ffcc00; }

        /* --- åˆ†é èˆ‡Modal --- */
        .pagination {
            display: flex; justify-content: center; align-items: center;
            gap: 1rem; margin-top: 1rem; margin-bottom: 1rem;
        }
        .page-btn {
            padding: 0.3rem 0.8rem; font-size: 0.9rem; cursor: pointer;
            background-color: #fff; border: 1px solid #999; border-radius: 4px;
        }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-overlay); display: none;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .modal-content {
            background: #fff; width: 90%; max-width: 70ch; max-height: 90vh;
            overflow-y: auto; padding: 1.5rem; border: 2px solid #000;
            border-radius: 0.5rem; position: relative;
        }
        .modal-body { white-space: pre-wrap; line-height: 1.8; }
        .modal-body * { color: #000 !important; background: transparent !important; font-size: inherit !important; font-family: inherit !important; }
        .close-btn {
            position: absolute; top: 1rem; right: 1rem;
            background: #cc0000; color: #fff; border: 1px solid #000;
            padding: 0.3rem 1rem; font-weight: bold; cursor: pointer;
        }
        .attachments-area { background: #f4f4f4; padding: 1rem; border: 1px dashed #666; margin-top: 1rem; }
        .attachments-area a { color: var(--link-color); font-weight: bold; display: inline-block; padding: 0.3rem; }

        #loading { font-size: 0.9rem; color: #666; padding: 1rem; text-align: center; }

        @media (max-width: 600px) {
            .list-item { flex-direction: column; align-items: flex-start; gap: 0.3rem; }
            .list-date, .list-dept { width: auto; font-size: 0.85rem; display: inline-block; margin-right: 10px;}
            .modal-content { width: 95%; padding: 1rem; }
            .filter-section { gap: 0.3rem; }
            .filter-btn { font-size: 0.85rem; padding: 0.2rem 0.5rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="loading">â†» è³‡æ–™è¼‰å…¥ä¸­...</div>
    <nav class="filter-section" aria-label="å…¬å‘Šåˆ†é¡ç¯©é¸">
        <button class="filter-btn active" data-cat="all">å…¨éƒ¨å…¬å‘Š</button>
    </nav>
    <ul id="announcement-list" class="announcement-list" aria-live="polite"></ul>
    <div class="pagination" id="pagination-controls" style="display:none;">
        <button id="prev-btn" class="page-btn">â† ä¸Šä¸€é </button>
        <span id="page-info" style="font-weight:bold; font-size: 0.9rem;">1 / 1</span>
        <button id="next-btn" class="page-btn">ä¸‹ä¸€é  â†’</button>
    </div>
</div>

<div id="detail-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
        <button id="modal-close-btn" class="close-btn" aria-label="é—œé–‰è¦–çª—">é—œé–‰ X</button>
        <div style="border-bottom: 2px solid #eee; margin-bottom: 1rem; padding-bottom: 0.5rem;">
            <h2 id="modal-title" style="margin:0 0 10px 0;">å…¬å‘Šè©³ç´°å…§å®¹</h2>
            <div style="color:#555;">
                <span id="modal-date"></span> | <span id="modal-dept"></span>
            </div>
        </div>
        <div id="modal-body" class="modal-body"></div>
        <div id="modal-attachments" class="attachments-area" style="display:none;">
            <h3>ğŸ“ é™„ä»¶ä¸‹è¼‰ï¼š</h3>
            <ul id="attachment-list" style="padding-left:1.5rem;"></ul>
        </div>
    </div>
</div>

<script>
    // è«‹ç¢ºèªé€™æ˜¯ä¸æ˜¯æ‚¨æœ€æ–°çš„ GAS ç¶²å€
    const DATA_URL = "https://script.google.com/macros/s/AKfycbwYL8U7s2Q-xNH5rkiN6XUrAs2NxA1ymKiOwDu-syHUpZgle2DZDL46GFLxHyFnKK13/exec";
    const ITEMS_PER_PAGE = 15;
    const NEW_DAYS_LIMIT = 7; 

    // â˜… é—œéµä¿®æ”¹ï¼šä½¿ç”¨ Base64 ç·¨ç¢¼çš„åœ–ç¤ºï¼Œä¸å†ä¾è³´å¤–éƒ¨é€£çµ â˜…
    // ç´…è‰²ç½®é ‚ç®­é ­
    const ICON_TOP_BASE64 = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23d32f2f'%3E%3Cpath d='M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z'/%3E%3C/svg%3E`;
    // ç´…è‰² NEW æ¨™ç±¤
    const ICON_NEW_BASE64 = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 45 20'%3E%3Crect width='45' height='20' rx='4' fill='%23d32f2f'/%3E%3Ctext x='50%25' y='50%25' dy='.35em' text-anchor='middle' fill='white' font-family='Arial' font-weight='bold' font-size='11'%3ENEW%3C/text%3E%3C/svg%3E`;

    const CATEGORY_MAP = {
        "2": "è¡Œæ”¿å…¬å‘Š", "35": "è£œåŠ©åŠçåŠ©å­¸é‡‘", "36": "äººäº‹å®¤å…¬å‘Š", "30": "æœƒè¨ˆå®¤å…¬å‘Š",
        "31": "å®¶é•·å°ˆå€", "38": "æ€§åˆ¥å¹³ç­‰", "28": "äººæ¬ŠäºŒå…¬ç´„", "37": "æ ¡å…§å…¬å‘Š",
        "48": "äººå“¡ç”„é¸", "39": "å¹¼å…’åœ’", "29": "é«”è‚²è³½äº‹ã€æ´»å‹•", "156": "æ–°ç”Ÿå ±åˆ°å°ˆå€",
        "168": "å®‰å…¨æ£’çƒ", "7": "ç ”ç¿’å…¬å‘Š"
    };

    let allData = [];
    let filteredData = []; 
    let currentPage = 1;
    let currentCategory = 'all';
    let lastFocusedElement = null;

    const listContainer = document.getElementById('announcement-list');
    const loadingDiv = document.getElementById('loading');
    const paginationControls = document.getElementById('pagination-controls');
    const pageInfo = document.getElementById('page-info');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const filterSection = document.querySelector('.filter-section');
    
    // Modal
    const modal = document.getElementById('detail-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalDate = document.getElementById('modal-date');
    const modalDept = document.getElementById('modal-dept');
    const modalBody = document.getElementById('modal-body');
    const modalAttachments = document.getElementById('modal-attachments');
    const attachmentList = document.getElementById('attachment-list');
    const closeBtn = document.getElementById('modal-close-btn');

    function checkIsNew(dateStr) {
        if (!dateStr) return false;
        const parts = dateStr.split(' ')[0].split('.'); 
        if (parts.length !== 3) return false;
        
        const year = parseInt(parts[0]) + 1911;
        const month = parseInt(parts[1]) - 1; 
        const day = parseInt(parts[2]);
        
        const postDate = new Date(year, month, day);
        const today = new Date();
        const diffTime = Math.abs(today - postDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        return diffDays <= NEW_DAYS_LIMIT;
    }

    fetch(DATA_URL)
        .then(res => res.json())
        .then(json => {
            if (json.status !== "success") throw new Error("GAS Error");
            loadingDiv.style.display = 'none';
            if (!json.data || json.data.length === 0) {
                listContainer.innerHTML = "<li style='padding:10px; color:#666;'>ç›®å‰æ²’æœ‰å…¬å‘Šã€‚</li>";
                return;
            }
            allData = json.data;
            filteredData = allData; 
            initFilters();
            initPagination();
            renderPage(1);
        })
        .catch(err => {
            console.error(err);
            loadingDiv.innerHTML = `<span style="color:red; font-size:0.9rem;">è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ã€‚</span>`;
        });

    function initFilters() {
        const counts = {};
        allData.forEach(item => {
            const catId = item.category_id;
            if (catId) counts[catId] = (counts[catId] || 0) + 1;
        });

        Object.keys(CATEGORY_MAP).forEach(catId => {
            const name = CATEGORY_MAP[catId];
            const count = counts[catId] || 0;
            const btn = document.createElement('button');
            btn.className = 'filter-btn';
            btn.dataset.cat = catId;
            btn.innerHTML = `${name} <span class="count-badge">${count}</span>`;
            btn.addEventListener('click', () => {
                applyFilter(catId);
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
            filterSection.appendChild(btn);
        });

        const allBtn = document.querySelector('[data-cat="all"]');
        allBtn.innerHTML = `å…¨éƒ¨å…¬å‘Š <span class="count-badge">${allData.length}</span>`;
        allBtn.addEventListener('click', () => {
            applyFilter('all');
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            allBtn.classList.add('active');
        });
    }

    function applyFilter(category) {
        currentCategory = category;
        filteredData = (category === 'all') ? allData : allData.filter(item => item.category_id == category);
        currentPage = 1;
        renderPage(1);
        updatePaginationVisibility();
    }

    function updatePaginationVisibility() {
        paginationControls.style.display = (filteredData.length > ITEMS_PER_PAGE) ? 'flex' : 'none';
    }

    function initPagination() {
        updatePaginationVisibility();
        prevBtn.addEventListener('click', () => { if (currentPage > 1) renderPage(currentPage - 1); });
        nextBtn.addEventListener('click', () => { 
            const maxPage = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
            if (currentPage < maxPage) renderPage(currentPage + 1); 
        });
    }

    function renderPage(page) {
        currentPage = page;
        listContainer.innerHTML = "";
        
        if (filteredData.length === 0) {
            listContainer.innerHTML = "<li style='padding:20px; text-align:center; color:#666;'>æ­¤åˆ†é¡æ²’æœ‰å…¬å‘Šã€‚</li>";
            pageInfo.textContent = "0 / 0";
            return;
        }

        const start = (page - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const pageItems = filteredData.slice(start, end);
        const maxPage = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
        
        pageInfo.textContent = `${currentPage} / ${maxPage}`;
        prevBtn.disabled = (currentPage === 1);
        nextBtn.disabled = (currentPage === maxPage);

        pageItems.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'list-item';
            const simpleDate = item.date ? item.date.split(' ')[0] : '-';
            const catName = CATEGORY_MAP[item.category_id] || item.department;

            // â˜… åœ–ç¤ºé¡¯ç¤ºé‚è¼¯ â˜…
            let topHtml = "";
            // é€™è£¡ä½¿ç”¨å¯¬é¬†åˆ¤æ–·ï¼Œåªè¦æ˜¯ 1 æˆ– "1" éƒ½æœƒé¡¯ç¤º
            if (item.is_top == 1) {
                topHtml = `<img src="${ICON_TOP_BASE64}" class="icon-top" alt="ç½®é ‚">`;
            }

            let newHtml = "";
            if (checkIsNew(item.date)) {
                newHtml = `<img src="${ICON_NEW_BASE64}" class="icon-new" alt="New">`;
            }

            li.innerHTML = `
                <div class="list-date" aria-label="æ—¥æœŸ">${simpleDate}</div>
                <div class="list-dept" aria-label="åˆ†é¡">${catName}</div>
                <div class="list-title">
                    <button class="title-btn" onclick="openDetails(${start + index})" aria-label="æŸ¥çœ‹ï¼š${item.title}">
                        ${topHtml}${item.title}${newHtml}
                    </button>
                </div>
            `;
            listContainer.appendChild(li);
        });
    }

    window.openDetails = function(index) {
        const item = filteredData[index];
        lastFocusedElement = document.activeElement;
        modalTitle.textContent = item.title;
        modalDate.textContent = "ç™¼å¸ƒæ—¥æœŸï¼š" + item.date;
        modalDept.textContent = "ç™¼å¸ƒå–®ä½ï¼š" + item.department;
        modalBody.innerHTML = item.content_html;
        if (item.attachments && item.attachments.length > 0) {
            modalAttachments.style.display = 'block';
            attachmentList.innerHTML = item.attachments.map(f => `
                <li><a href="${f.url}" target="_blank">ä¸‹è¼‰ï¼š${f.name}</a></li>
            `).join('');
        } else {
            modalAttachments.style.display = 'none';
        }
        modal.style.display = 'flex';
        closeBtn.focus();
        document.body.style.overflow = 'hidden';
    };

    function closeModal() {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        if (lastFocusedElement) lastFocusedElement.focus();
    }

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.style.display === 'flex') closeModal(); });

</script>

</body>
</html>